<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academia 4.3.1"><meta name=generator content="Hugo 0.73.0"><meta name=author content="Jing Lin (林静)"><meta name=description content="Managing outbound traffic policies in Kubernetes, a seemingly simple requirement, actually is not an easy task to do well."><link rel=alternate hreflang=en-us href=http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/><meta name=theme-color content="#3f51b5"><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.0/css/all.css integrity=sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h crossorigin=anonymous><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/highlight.js/9.15.6/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans|Roboto+Mono&display=swap"><link rel=stylesheet href=/css/academia.min.bcef5eaccde0f18047d8dcec72cc428c.css><link rel=manifest href=/site.webmanifest><link rel=icon type=image/png href=/img/icon.png><link rel=apple-touch-icon type=image/png href=/img/icon-192.png><link rel=canonical href=http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@linjingchina"><meta property="twitter:creator" content="@linjingchina"><meta property="og:site_name" content="Jing Lin‘s profile"><meta property="og:url" content="http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/"><meta property="og:title" content="Why K8s Egress Traffic Policy Control is Critical to Security Architecture | Jing Lin‘s profile"><meta property="og:description" content="Managing outbound traffic policies in Kubernetes, a seemingly simple requirement, actually is not an easy task to do well."><meta property="og:image" content="http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/featured.png"><meta property="twitter:image" content="http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-08-06T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-25T19:59:56+08:00"><title>Why K8s Egress Traffic Policy Control is Critical to Security Architecture | Jing Lin‘s profile</title></head><body id=top data-spy=scroll data-target=#TableOfContents data-offset=71><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off role=textbox spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id=navbar-main><div class=container><a class=navbar-brand href=/>Jing Lin‘s profile</a>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label="Toggle navigation"><span><i class="fas fa-bars"></i></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#skills><span>Skills</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#accomplishments><span>Accomplishments</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#experience><span>Experience</span></a></li><li class=nav-item><a class="nav-link active" href=/><span>Courses</span></a></li><li class=nav-item><a class=nav-link href=/#slider><span>Customers</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></div></nav><article class="article py-5" itemscope itemtype=http://schema.org/Article><div class="container split-header"><div class="row justify-content-center"><div class=col-lg-8><img class="img-fluid w-100" src=/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/featured_hu193e6093f7c5c16745f0555aa8206c3b_220072_680x500_fill_q90_lanczos_smart1_2.png itemprop=image alt>
<span class=article-header-caption>The picture from internet.</span></div><div class=col-lg-8><h1 itemprop=name>Why K8s Egress Traffic Policy Control is Critical to Security Architecture</h1><p class=page-subtitle>An article discuss why and what way to control egress traffic in k8s</p><meta content="2022-08-06 00:00:00 +0000 UTC" itemprop=datePublished><meta content="2024-12-25 19:59:56 +0800 +0800" itemprop=dateModified><div class=article-metadata><div><span itemprop="author name" itemtype=http://schema.org/Person>Jing Lin(林静)</span></div><span class=article-date>Last updated on
<time>Dec 25, 2024</time></span>
<span class=middot-divider></span><span class=article-reading-time>4 min read</span>
<span class=middot-divider></span><a href=/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/#disqus_thread></a><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/&text=Why%20K8s%20Egress%20Traffic%20Policy%20Control%20is%20Critical%20to%20Security%20Architecture" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/&t=Why%20K8s%20Egress%20Traffic%20Policy%20Control%20is%20Critical%20to%20Security%20Architecture" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook-f"></i></a></li><li><a href="mailto:?subject=Why%20K8s%20Egress%20Traffic%20Policy%20Control%20is%20Critical%20to%20Security%20Architecture&body=http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/&title=Why%20K8s%20Egress%20Traffic%20Policy%20Control%20is%20Critical%20to%20Security%20Architecture" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="https://web.whatsapp.com/send?text=Why%20K8s%20Egress%20Traffic%20Policy%20Control%20is%20Critical%20to%20Security%20Architecture%20http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=http://linjing.io/post/why-k8s-egress-traffic-policy-control-is-critical-to-security-architecture/&title=Why%20K8s%20Egress%20Traffic%20Policy%20Control%20is%20Critical%20to%20Security%20Architecture" target=_blank rel=noopener class=share-btn-weibo><i class="fab fa-weibo"></i></a></li></ul></div></div></div></div></div></div><div class=article-container><div class=article-style itemprop=articleBody><h2 id=why-egress-traffic-policy-control>Why Egress Traffic Policy Control</h2><p>According to the 2021 CNCF survey, the proportion of users who use Kubernetes (K8s) in the production environment has reached 59.77%, and the number of European users has reached 68.98%. More and more users are migrating production services to the Kubernetes environment. Gartner 2021 Hype Cycle for Cloud Security also shows that container and Kubernetes security is already in the &ldquo;slope of Enlightenment&rdquo; stage. This shows that protecting application services in Kubernetes is becoming more and more important.</p><p>When we look at a large number of microservices running in Kubernetes, we can see that microservice security has the characteristics of typical micro-boundaries and need continuous security engineering. We need consider each microservice as a boundary and protect it, whether runtime, or north-south and east-west traffic. It is necessary for each microservice to start security considerations at the beginning of coding, and to move security to the left. Security methods, and policies should be adapted to developers and Kubernetes platform operators. It also requires the ability to gain insight into all traffic, collect all runtime logs, events and other data, analyze these data through a continuous security engineering system, aggregate rules and feed them back into security policy settings.</p><p><img src="https://community.f5.com/t5/image/serverpage/image-id/18348i39592BD75177EE79/image-size/large?v=v2&px=999" alt=image-20220708090843383.png></p><p>The microservices in Kubernetes will not only run closed inside the cluster, it needs to access applications, databases, third-party API services, Internet services, etc. outside the cluster. The outgoing traffic may include the business traffic, open source component update traffic, or even traffic from the compromised application to the C2. Therefore, it is necessary to actively control the egress traffic of microservices in Kubernetes to ensure its security and compliance. Under the digital transformation driven by cloud-native architecture, enterprises will adopt a large number of open source technologies, which may be the easiest place to introduce security risks. Regardless of whether there is a clear open source whitelist mechanism, enterprises should pay enough attention to these open source technologies. These open source may take the initiative to visit the outside, we need control it well, and ensure safety.</p><p>Managing outbound traffic policies in Kubernetes, a seemingly simple requirement, actually is not an easy task to do well. This article will analyze the challenges of Kubernetes outbound policies with you, analyze the advantages and disadvantages of current common solutions, and think about how enterprises should manage and control Kubernetes egress traffic policies.</p><h2 id=existing-challenges>Existing challenges</h2><h3 id=dynamic>Dynamic</h3><p>From a technical point of view, this is the first challenge that exists. In a Kubernetes environment, the pods of the microservice will be highly dynamic and decentralized. IPs, network segments and physical locations will change over time. Therefore, it will be impossible to directly use IP and other characteristics for static policy setting. The strategy must rely on other abstract application labels, service names or namespaces, etc., and can dynamically perceive changes.</p><h3 id=granularity>Granularity</h3><p>In a traditional application environment, the management and control of an application&rsquo;s outbound traffic policy generally only requires policy setting for a small number of deployments involved in the application. However, in the environment of microservices and containerization, an application may be composed of many microservices, and a microservice contains many pods. Different microservice units will require different outbound policy rules. For example, payment needs to connect to a third-party interface, while the comment service does not need to actively access third-party services. This means that the granularity of policy setting needs to be fine-grained to each microservice unit and ensure that all relevant pods are controlled. It can be seen that the policy control granularity is finer, the workload is larger, and the complexity is higher.</p><h3 id=collaboration>Collaboration</h3><p>When we want to deploy egress policies for different microservice, who should be responsible for this, the application development department? Application operation and maintenance department? PlatformOps division of Kubernetes? Or the security department? When we look at this with a security-left shift, it is obvious that the application department should consider whether his microservices need to actively access which external services. However, if the application developer is in charge, can the platform or security department just let it go? Obviously not, application developers set up security policies for the applications they are responsible for. Global basic security policies setting, and how to quickly remedy the wrong policies set by application developers, These still need to be taken care of by other teams. In order for the development department to practice the idea of security shift left, Platform ops team or the security department must provide friendly tools and integrate the security policy setting into the DevSecOps pipeline. If the tools or methods lead to a decline in development efficiency, developers will not be happy to use it. Therefore, this is not the independent work of a certain department, it requires the cooperation of multiple teams/departments to ensure safety.</p><h3 id=data-driven>Data driven</h3><p>As stated at the beginning of the article, security is a continuous engineering effort, meaning that any outgoing access behavior and events should be logged into the security engineering system for analysis to ensure adequate visibility and insight. Egress security control is not only a simple policy setting, but also requires the ability to output complete logs, behaviors, and events.</p><h2 id=industry-solution-analysis>Industry solution analysis</h2><p>Next, we will analyze the current industry solutions for egress policy control one by one. First, we will divide them into 6 categories of solutions, and then analyze them one by one:</p><table><thead><tr><th>**Category **</th><th>**Solutions or products **</th><th>**Description **</th></tr></thead><tbody><tr><td>Platform based</td><td>Kubernetes Network policy Openshift EgressIP Openshift Egress Router pod Openshift Egress Firewall Openshift EgressNetworkPolicy</td><td>A specific feature of a platform provider</td></tr><tr><td>CNI based</td><td>Calico Egress pod Calico Enhanced Network policy Cilium Enhanced Network policy Kube-ovn</td><td>The capability of CNI</td></tr><tr><td>Service Mesh</td><td>NGINX Service Mesh Istio</td><td>A function of Service Mesh</td></tr><tr><td>Micro segmentation</td><td>PrismaNeu Vector</td><td>From ZTA perspective or use enforcer container to control egress</td></tr><tr><td>Fusion</td><td>F5 CES(Container Egress Service) Fortinet</td><td>Use k8s native method to integrate exist security assets to k8s</td></tr><tr><td>Others</td><td>DNS interception Proxy pod</td><td>Intercept coredns or use a proxy pod as forward proxy</td></tr></tbody></table><h3 id=platform-based>Platform based</h3><p>The Network policy that comes with Kubernetes is the easiest way to think about egress security policy control. It is the native ability of K8s, which has natural affinity for developers or PlatformOps personnel, and can well adapt to the idea of security left shift. But Network policy needs CNI support. Some other disadvantages are:</p><ul><li>No cluster global policy capability, independent policies must be maintained under different namespaces</li><li>No selection capability based on k8s svc name (can be changed to use pod label, but inflexible)</li><li>No explicit rejection ability, through the isolation characteristics of the policy, and then impose a specific whitelist</li><li>Rules without priority concept</li><li>No dedicate external access rule type, external target services can only rely on broad ipblock</li><li>pure four-layer, no seven-layer control capability</li><li>No policy execution debugging capability</li><li>No policy execution log</li><li>The &ldquo;isolation&rdquo; feature of Networkpolicy makes maintenance very troublesome. For example, it only wants to control its access to the Internet, but because of isolation, additional maintenance is required All outbound (east-west) access of the pod within the cluster</li><li>Does not solve the problem of k8s working with external security devices. Just imagine, after Network policy has made rule control, can an external security device open a default allow rule for the cluster?</li></ul><p>Openshift has four features related to Egress, namely standard Network Policy, Egress IP, Egress Router, Egress Firewall and Egress NetworkPolicy.</p><ul><li>Network Policy, which is fully supported when Openshift uses OVN-Kubernetes as the CNI, while the traditional Openshift SDN CNI is only partially supported. It is no different from standard Kubernetes, and its advantages and disadvantages will not be analyzed here.</li><li>EgressIP is a function to use deterministic source IP when Pods traffic leaves the cluster. When using Openshift SDN CNI, this function applies the Egress IP to the specified nodes as secondary IP and is used for SNAT. When using OVN-Kubernetes CNI, the snat rules are executed for specific pods through OVS. Using EgressIP itself is not a direct method for egress security policy control, but by specifying a certain source IP for different namespaces, some policies can be deployed on security devices outside the cluster to perform control. Obviously, this policy control method is relatively extensive, and cannot achieve the fine-grained granularity of different services. If the pods are scattered on different nodes, there will also be the problem that the outgoing cluster traffic of the pods must first traverse between different nodes, adding extra delay. In addition, the EgressIP must belong to the same network segment as the node&rsquo;s main network address, and a node cannot have more than one EgressIP. EgressIP also does not support public cloud and Redhat Openstack Platform.</li><li>Egress Router Pod, which is a special pod with two network interfaces, and uses MacVlan technology to directly connect one of the container network interface to the external network. All pods out-of-cluster traffic will pass through this pod. Different CNIs (SDN or OVN-Kubernetes) have different functions for the pod. Only redirection operations are supported under OVN-Kubernetes CNI. Generally speaking, this is not suitable for large-scale use. From the perspective of Egress security policy setting, it is still impossible to distinguish between different services, and the centralized Egress pod can easily become a performance bottleneck.</li><li>EgressFirewall, which is actually a feature of OVN-Kubernetes. Allows setting outbound access rules for a project or namespace, which can be based on protocols, ports, IP, FQDN and other dimensions. The protocol only supports TCP, UDP, SCTP, and cannot support other protocol control. It only allows setting based on the namespace level. Only one rule file is allowed to be set in a namespace, and cannot set different rules for different services in the cluster. Also it limits each namespace/project to a maximum of 8000 rules. Observables or events are also not supported.</li><li>Egress NetworkPolicy, similar to EgressFirewall, supports this CRD when using Openshift SDN CNI. But the Egress NetworkPolicy is more restrictive, for example, each namespace/project supports a maximum of 1000 rules, and the network policy or multitenant mode must be turned on.</li></ul><p><strong>&#187; <a href=https://community.f5.com/t5/technical-articles/what-you-should-know-about-k8s-egress-traffic-policy-control/ta-p/297895>Click here</a> for continue reading(2/2)</strong></p></div><div class=article-tags><a class="badge badge-light" href=/tags/k8s/>k8s</a>
<a class="badge badge-light" href=/tags/egress/>egress</a>
<a class="badge badge-light" href=/tags/security/>security</a></div><div class=article-widget><div class=hr-light></div><h3>Related</h3><ul><li><a href=/post/f5-container-egress-service-ces/>Project- Container Egress Service(CES)</a></li></ul></div><section id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"linjingio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><script src=https://cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdn.bootcdn.net/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdn.bootcdn.net/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdn.bootcdn.net/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin=anonymous></script><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/9.15.6/highlight.min.js integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin=anonymous></script><script id=dsq-count-scr src=//linjingio.disqus.com/count.js async></script><script>hljs.initHighlightingOnLoad();</script><script>const search_index_filename="/index.json";const i18n={'placeholder':"Search...",'results':"results found",'no_results':"No results found"};const content_type={'post':"Posts",'project':"Projects",'publication':"Publications",'talk':"Talks"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdn.bootcdn.net/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdn.bootcdn.net/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academia.min.e4fc229c2f28284fc2dfa5b66a52b765.js></script><div class=container><footer class=site-footer><div class=container><div class=row><div class=col-md-6><p>Copyright © 2024 linjing.io host on github, imesh.cloud host on netlify. CI/CD by github actions and netlify.Thanks bootcdn support for front libary CDN &#183;
Powered by
<a href=https://themefisher.com target=_blank rel=noopener>themefisher</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.</p></div><div class=col-md-6><ul class="list-inline network-icon text-right"><li class=list-inline-item><a href=https://twitter.com/linjingchina target=_blank rel=noopener title="DM Me"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class=list-inline-item><a href=https://github.com/myf5 target=_blank rel=noopener title=Github><i class="fab fa-github" aria-hidden=true></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/in/jing-lin-218b3915/ target=_blank rel=noopener title=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=list-inline-item><a href=https://imesh.club target=_blank rel=noopener title="My blog"><i class="fab fa-wordpress" aria-hidden=true></i></a></li></ul></div></div></div></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>